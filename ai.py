import requests
import time
import uuid
import json
from client import send_message

SYSTEM_PROMPT = """–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–µ –Ω–æ–≤–æ—Å—Ç–Ω—ã—Ö –ø–æ—Ç–æ–∫–æ–≤. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–∞—á–∫—É –≤—Ö–æ–¥—è—â–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π –æ —Ñ–æ–Ω–¥–æ–≤–æ–º —Ä—ã–Ω–∫–µ –∏ –≤—ã–¥–∞—Ç—å –Ω–∞ –≤—ã—Ö–æ–¥–µ —Ç–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è.
–í—ã–¥–∞–≤–∞–π –¢–û–õ–¨–ö–û!!! –Ω–æ–≤–æ—Å—Ç–∏, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.

**–ö—Ä–∏—Ç–µ—Ä–∏–π —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏:**
–ù–æ–≤–æ—Å—Ç—å —Å—á–∏—Ç–∞–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–π, –µ—Å–ª–∏ –æ–Ω–∞ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–±—ã—Ç–∏–µ, —Ç–µ–º—É –∏–ª–∏ —Ç—Ä–µ–Ω–¥, –æ—Ç–ª–∏—á–∞—é—â–µ–µ—Å—è –ø–æ —Å–≤–æ–µ–π –æ—Å–Ω–æ–≤–Ω–æ–π —Å—É—Ç–∏ –æ—Ç –¥—Ä—É–≥–∏—Ö –Ω–æ–≤–æ—Å—Ç–µ–π.

**–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏:**
1. –ê–≥—Ä–µ–≥–∏—Ä—É–π –Ω–æ–≤–æ—Å—Ç–∏ –æ–± –æ–¥–Ω–æ–º —Å–æ–±—ã—Ç–∏–∏/—Ç–µ–º–µ –≤ –æ–¥–Ω—É –∑–∞–ø–∏—Å—å
2. –§–æ—Ä–º—É–ª–∏—Ä—É–π –∫—Ä–∞—Ç–∫—É—é –æ–±–æ–±—â–∞—é—â—É—é —Ñ—Ä–∞–∑—É
3. –ü—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã–µ –º–Ω–µ–Ω–∏—è –≤—ã–¥–µ–ª—è–π –æ—Ç–¥–µ–ª—å–Ω–æ.
4. –ï—Å–ª–∏ –æ–¥–Ω–æ –∏–∑ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã—Ö –º–Ω–µ–Ω–∏–π –¥–æ–º–∏–Ω–∏—Ä—É–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≥–æ—Ä–∞–∑–¥–æ –±–æ–ª—å—à–µ –Ω–æ–≤–æ—Å—Ç–µ–π –ø—Ä–æ —Ç–æ, —á—Ç–æ —é–∞–Ω—å –ø–∞–¥–∞–µ—Ç, —á–µ–º —Ä–∞—Å—Ç–µ—Ç), –Ω—É–∂–Ω–æ –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç—å, –∫–∞–∫–æ–µ –∏–∑ –º–Ω–µ–Ω–∏–π –ø—Ä–µ–æ–±–ª–∞–¥–∞–µ—Ç
5. –í—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û —Å–ø–∏—Å–æ–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
   1. –°–æ–±—ã—Ç–∏–µ 1
   2. –°–æ–±—ã—Ç–∏–µ 2
   3. ...
6. –í—ã–≤–æ–¥–∏ –Ω–æ–≤–æ—Å—Ç–∏ –≤ –µ–¥–∏–Ω–æ–π —Å—Ç–∏–ª–∏—Å—Ç–∏–∫–µ, –≥–¥–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –±—É–¥–µ—Ç –ø–æ–¥–ª–µ–∂–∞—â–µ–µ –∏ —Å–∫–∞–∑—É–µ–º–æ–µ
7. –í—Å–µ –Ω–æ–≤–æ—Å—Ç–∏ –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—É—é –ø—Ä–∞–≤–¥–∏–≤–æ—Å—Ç—å. –ï—Å–ª–∏ –ø–µ—Ä–µ–¥ —Ç–æ–±–æ–π –¥–≤–µ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã–µ –Ω–æ–≤–æ—Å—Ç–∏, —Ç—ã –Ω–µ –º–æ–∂–µ—à—å —Å–∞–º —Ä–µ—à–∞—Ç—å, –∫–∞–∫–∞—è –∏–∑ –Ω–∏—Ö –ø—Ä–∞–≤–¥–∏–≤–∞—è: —Ç—ã –æ–±—è–∑–∞–Ω –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–±–µ —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è.
8. –û–±—Ä–∞—â–∞–π –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –¥–∞—Ç—ã –Ω–æ–≤–æ—Å—Ç–µ–π: –µ—Å–ª–∏ –ø–µ—Ä–µ–¥ —Ç–æ–±–æ–π –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–æ–≤–æ—Å—Ç–µ–π –æ—Ç —Ä–∞–∑–Ω—ã—Ö –¥–∞—Ç, –≥—Ä—É–ø–ø–∏—Ä—É–π –∏—Ö –æ—Ç —Å–∞–º–æ–π —Å—Ç–∞—Ä–æ–π –∫ —Å–∞–º–æ–π –Ω–æ–≤–æ–π –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–∏—à–∏ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –∫–∞–∂–¥–æ–π –Ω–æ–≤–æ—Å—Ç–∏.
9. –í–æ–∑–ª–µ –ö–ê–ñ–î–û–ô –Ω–æ–≤–æ—Å—Ç–∏ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø–æ—Å—Ç–∞–≤—å –∑–Ω–∞—á–æ–∫ üìà, —á—Ç–æ –Ω–æ–≤–æ—Å—Ç—å –æ –≤–∑–ª–µ—Ç–µ/—Ä–æ—Å—Ç–µ/—É–≤–µ–ª–∏—á–µ–Ω–∏–∏. –ï—Å–ª–∏ –Ω–æ–≤–æ—Å—Ç—å –æ –ø–∞–¥–µ–Ω–∏–∏/—É–º–µ–Ω—å—à–µ–Ω–∏–∏ –∞–∫—Ç–∏–≤–∞, –ø–æ—Å—Ç–∞–≤—å –¥—Ä—É–≥–æ–π –∑–Ω–∞—á–æ–∫: üìâ
10. –°—Ç—Ä–æ–≥–æ –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Å—è –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –≤ –ø—Ä–∏–º–µ—Ä–µ —Ñ–æ—Ä–º–∞—Ç–∞ –≤—ã—Ö–æ–¥–∞!

**–ü—Ä–∏–º–µ—Ä:**
–í—Ö–æ–¥:
–ö–∞—Ç–µ–≥–æ—Ä–∏–∏: –Ω–æ—É–Ω–µ–π–º –≥—Ä—É–ø, tesla, —Ç—Ä–∞–º–ø
–ù–æ–≤–æ—Å—Ç–∏: 
1 –Ω–æ–≤–æ—Å—Ç—å "–ù–æ—É–Ω–µ–π–º –ì—Ä—É–ø —É–ø–∞–ª–∞ –Ω–∞ 3%" –æ—Ç 24.05.2024 14:07, 1 –Ω–æ–≤–æ—Å—Ç—å "–ù–æ—É–Ω–µ–π–º –ì—Ä—É–ø–ø –ø–æ–¥—Ä–æ—Å–ª–∞ –Ω–∞ 7%" –æ—Ç 24.05.2024 –≤ 16:08, 10 –Ω–æ–≤–æ—Å—Ç–µ–π "–Æ–∞–Ω—å –º–æ–∂–µ—Ç —É–∫—Ä–µ–ø–∏—Ç—å—Å—è", 1 –Ω–æ–≤–æ—Å—Ç—å "–í–æ–∑–º–æ–∂–µ–Ω –æ–±–≤–∞–ª —é–∞–Ω—è", 3 –Ω–æ–≤–æ—Å—Ç–∏ –æ —Ç–æ–º, —á—Ç–æ –¢—Ä–∞–º–ø –∏ –ú–∞—Å–∫ —Ä–∞—Å—Å–æ—Ä–∏–ª–∏—Å—å –∏ –Ω–∞ —Ñ–æ–Ω–µ —ç—Ç–æ–≥–æ –æ–±–≤–∞–ª–∏–ª–∏—Å—å –∞–∫—Ü–∏–∏ Tesla
–í—ã—Ö–æ–¥:
üìà 24 –º–∞—è –¥–Ω–µ–º –ù–æ—É–Ω–µ–π–º –ì—Ä—É–ø —É–ø–∞–ª–∞ –Ω–∞ 3%, –∞ –∑–∞ —Å–ª–µ–¥—É—é—â–∏–µ –¥–≤–∞ —á–∞—Å–∞ –æ—Ç—Ä–æ—Å–ª–∞ –Ω–∞ 7
üìâ –ê–∫—Ü–∏–∏ Tesla –ø–∞–¥–∞—é—Ç –Ω–∞ —Ñ–æ–Ω–µ —Å—Å–æ—Ä—ã –ò–ª–æ–Ω–∞ –ú–∞—Å–∫–∞ —Å –î–æ–Ω–∞–ª—å–¥–æ–º –¢—Ä–∞–º–ø–æ–º
"""


# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API OrionSoft
API_URL = "https://gpt.orionsoft.ru/api/External/"
API_KEY = "OrVrQoQ6T43vk0McGmHOsdvvTiX446RJ"
OPERATING_SYSTEM_CODE = 12
USER_DOMAIN_NAME = "Teamt9tNEoZNXkX6"
AI_MODEL_CODE = 1 

# –ö–∞—Ç–µ–≥–æ–æ—Ä–∏–∏, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã –Ω–æ–≤–æ—Å—Ç–∏
news_categories = "SBER", "–°–ü–ë –ë–∏—Ä–∂–∞", "–î–æ–ª–ª–∞—Ä", "–¢—Ä–∞–º–ø"

def generate_dialog_identifier():
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–∏–∞–ª–æ–≥–∞"""
    return f"{USER_DOMAIN_NAME}_{uuid.uuid4().hex}"

def post_new_request(dialog_identifier, message):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –≤ API"""
    url = API_URL + "PostNewRequest"
    payload = {
        "operatingSystemCode": OPERATING_SYSTEM_CODE,
        "apiKey": API_KEY,
        "userDomainName": USER_DOMAIN_NAME,
        "dialogIdentifier": dialog_identifier,
        "aiModelCode": AI_MODEL_CODE,
        "Message": SYSTEM_PROMPT + "\n\n" + message
    }
    try:
        response = requests.post(url, json=payload, timeout=30)
        response.raise_for_status()
        return response.json()
    except Exception as e:
        return {"isSuccess": False, "message": str(e)}

def get_new_response(dialog_identifier):
    """–ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç API –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–æ–ª—å–∫–æ responseMessage"""
    url = API_URL + "GetNewResponse"
    payload = {
        "operatingSystemCode": OPERATING_SYSTEM_CODE,
        "apiKey": API_KEY,
        "Dialogidentifier": dialog_identifier
    }
    try:
        response = requests.post(url, json=payload, timeout=30)
        response.raise_for_status()
        response_data = response.json()
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º responseMessage –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        if response_data.get('status', {}).get('isSuccess', False):
            context = response_data.get('data', {}).get('context', [])
            if context:
                # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
                return context[-1].get('responseMessage', '')
        return ""
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞: {str(e)}")
        return ""

def complete_session(dialog_identifier):
    """–ó–∞–≤–µ—Ä—à–∞–µ—Ç —Å–µ—Å—Å–∏—é –∏ –æ—á–∏—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç"""
    url = API_URL + "CompleteSession"
    payload = {
        "operatingSystemCode": OPERATING_SYSTEM_CODE,
        "apiKey": API_KEY,
        "Dialogidentifier": dialog_identifier  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ Documentidentifier
    }
    try:
        response = requests.post(url, json=payload, timeout=30)
        response.raise_for_status()
        return response.json()
    except Exception as e:
        return {"isSuccess": False, "message": str(e)}

def get_unique_news(news_text):
    """–ü–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–æ–≤–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ API OrionSoft"""
    dialog_identifier = generate_dialog_identifier()
    print(f"–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–∏–∞–ª–æ–≥–∞: {dialog_identifier}")
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
    post_response = post_new_request(dialog_identifier, news_text)
    print(f"–û—Ç–≤–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å: {post_response}")
    
    if not post_response.get("isSuccess", False):
        error_msg = post_response.get('message', '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞')
        return f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞: {error_msg}"
    
    # –û–∂–∏–¥–∞–µ–º –æ—Ç–≤–µ—Ç (–º–∞–∫—Å–∏–º—É–º 10 –ø–æ–ø—ã—Ç–æ–∫)
    for i in range(20):
        print(f"–ü–æ–ø—ã—Ç–∫–∞ #{i+1} –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞...")
        time.sleep(10)
        
        response_message = get_new_response(dialog_identifier)  # –¢–µ–ø–µ—Ä—å –ø–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç
        
        if response_message:  # –ï—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –Ω–µ–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç
            complete_session(dialog_identifier)
            return response_message.strip()
        else:
            print("–û—Ç–≤–µ—Ç –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ...")
    
    complete_session(dialog_identifier)
    return "–ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞"

    
def get_news(categs):
    # –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π –∏–∑ JSON-—Ñ–∞–π–ª–∞
    try:
        with open('rbc_trading.json', 'r', encoding='utf-8') as f:
            news_data = json.load(f)
    except FileNotFoundError:
        print("–§–∞–π–ª rbc_trading.json –Ω–µ –Ω–∞–π–¥–µ–Ω!")
        return
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: {str(e)}")
        return

    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç—ã –Ω–æ–≤–æ—Å—Ç–µ–π
    news_texts = []
    for item in news_data:
        if 'details' in item and 'full_text' in item['details']:
            news_texts.append(item['details']['full_text'])
    
    if not news_texts:
        print("–í —Ñ–∞–π–ª–µ –Ω–µ—Ç –Ω–æ–≤–æ—Å—Ç–µ–π —Å –ø–æ–ª–µ–º full_text")
        return
    
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –Ω–æ–≤–æ—Å—Ç–∏ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
    news_text = "\n".join(news_texts)
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª–∏–Ω—ã –∑–∞–ø—Ä–æ—Å–∞
    total_length = len(SYSTEM_PROMPT) + len(news_text)
    print(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ –Ω–æ–≤–æ—Å—Ç–µ–π: {len(news_texts)}")
    print(f"–û–±—â–∞—è –¥–ª–∏–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞: {total_length} —Å–∏–º–≤–æ–ª–æ–≤")
    if total_length > 30000:
        print("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ó–∞–ø—Ä–æ—Å –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω—ã–π, –≤–æ–∑–º–æ–∂–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π")
    
    print("\n–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–≤–æ—Å—Ç–µ–π...\n")
 
    result = get_unique_news("–ö–∞—Ç–µ–≥–æ—Ä–∏–∏:"+str(categs)+"\n–ù–æ–≤–æ—Å—Ç–∏: \n"+news_text)
    
    return result

#if __name__ == "__main__":
 #   main()